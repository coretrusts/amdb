# 索引和分片数据查询验证报告

## 验证结果

### ✅ 索引更新正确性

#### 单个写入操作（put）
- **版本管理器**：✓ 正常更新
- **索引管理器**：✓ 正常更新（主键索引、版本索引、时间索引）
- **存储引擎**：✓ 正常写入（LSM树、B+树、Merkle树）
- **分片支持**：✓ 自动分片，数据分布到不同分片

#### 批量写入操作（batch_put）
- **版本管理器**：✓ 正常更新
- **索引管理器**：✓ 已修复，现在正常更新
- **存储引擎**：✓ 正常写入（支持分片批量写入）
- **分片支持**：✓ 按分片分组批量写入，提高性能

### ✅ 分片数据查询

#### 读取操作（get）
- **版本管理器优先**：✓ 优先从版本管理器读取（内存，最新）
- **存储引擎回退**：✓ 如果版本管理器没有，从存储引擎读取
- **分片自动定位**：✓ 根据key自动计算shard_id，从对应分片读取
- **多分片支持**：✓ 支持从所有分片读取数据

#### 范围查询（select * from <prefix>）
- **CLI支持**：✓ 支持范围查询，从版本管理器获取所有键，然后过滤
- **GUI支持**：✓ 支持范围查询，与CLI逻辑一致
- **分片数据**：✓ 能正确查询所有分片中的数据
- **索引加速**：✓ 使用索引加速查询（主键索引）

### ✅ CLI查询功能

#### 单个键查询
```bash
select user:001
```
- ✓ 支持单个键查询
- ✓ 自动从版本管理器或存储引擎读取
- ✓ 支持分片数据查询

#### 范围查询
```bash
select * from user
select * from user limit 5000
```
- ✓ 支持范围查询
- ✓ 支持limit参数
- ✓ 从版本管理器获取所有键，然后过滤
- ✓ 支持分片数据查询

### ✅ GUI查询功能

#### 单个键查询
- ✓ 支持单个键查询
- ✓ 使用DatabaseWrapper统一接口
- ✓ 支持分片数据查询

#### 范围查询
- ✓ 支持 `SELECT * FROM <prefix> [LIMIT <n>]` 语法
- ✓ 支持limit参数（LIMIT或LIMITED）
- ✓ 从版本管理器获取所有键，然后过滤
- ✓ 支持分片数据查询

## 索引更新流程

### 单个写入（put）
```
put(key, value)
  ↓
1. version_manager.create_version()  ← 创建版本对象
  ↓
2. storage.put()  ← 写入存储引擎（自动分片）
  ↓
3. index_manager.put()  ← 更新索引 ✓
  ↓
4. wal_logger.log_put()  ← 写入WAL（异步）
  ↓
5. audit_logger.log_put()  ← 记录审计日志（异步）
```

### 批量写入（batch_put）
```
batch_put(items)
  ↓
1. version_manager.create_versions_batch()  ← 批量创建版本对象
  ↓
2. storage.lsm_tree.batch_put()  ← 批量写入存储引擎（按分片分组）
  ↓
3. index_manager.put() (批量)  ← 批量更新索引 ✓（已修复）
  ↓
4. 返回成功
```

## 分片数据查询流程

### 读取单个键（get）
```
get(key)
  ↓
1. _check_and_reload_if_updated()  ← 检查文件更新
  ↓
2. version_manager.get_latest()  ← 优先从版本管理器读取
  ↓ (如果失败)
3. storage.get()  ← 从存储引擎读取
   ├─ ShardedLSMTree.get()
   │  ├─ 计算shard_id = shard_manager.get_shard_id(key)
   │  ├─ 从对应分片的MemTable读取
   │  ├─ 从对应分片的不可变MemTable读取
   │  └─ 从对应分片的SSTable读取
   └─ 返回结果
```

### 范围查询（select * from <prefix>）
```
select * from <prefix>
  ↓
1. version_manager.get_all_keys()  ← 获取所有键（不区分分片）
  ↓
2. 过滤匹配前缀的键
  ↓
3. 逐个读取值
   ├─ db.get(key)  ← 自动定位分片并读取
   └─ 显示结果
```

## 测试结果

### 测试1：单个写入 + 分片
- ✓ 版本管理器：10个键
- ✓ 索引管理器：10个索引
- ✓ 数据读取：10/10成功

### 测试2：批量写入 + 分片
- ✓ 版本管理器：20个键
- ✓ 索引管理器：20个索引（修复后）
- ✓ 数据读取：20/20成功
- ✓ 索引查询：20/20成功

### 测试3：范围查询 + 分片
- ✓ 总键数：50个键
- ✓ user: 前缀：30个键
- ✓ order: 前缀：20个键
- ✓ 数据读取：所有键都能正确读取

## 结论

1. **索引更新**：
   - ✅ 单个写入：索引正常更新
   - ✅ 批量写入：索引正常更新（已修复）
   - ✅ 分片数据：索引正常更新

2. **分片数据查询**：
   - ✅ 单个键查询：支持分片数据
   - ✅ 范围查询：支持分片数据
   - ✅ CLI查询：支持分片数据
   - ✅ GUI查询：支持分片数据

3. **性能**：
   - ✅ 分片自动定位，查询效率高
   - ✅ 索引加速查询
   - ✅ 批量写入按分片分组，减少锁竞争

## 使用建议

1. **启用分片**：
   - 大数据量场景建议启用分片
   - 默认分片数量：256
   - 可通过配置文件调整

2. **查询优化**：
   - 使用范围查询时，建议使用limit参数
   - 单个键查询性能最优
   - 索引会自动加速查询

3. **批量写入**：
   - 批量写入性能优于单个写入
   - 批量写入会自动按分片分组
   - 索引会自动更新，无需担心

